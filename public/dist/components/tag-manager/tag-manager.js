/**
 * @module       Tagmanager
 * @author       Max Favilli
 * @see          https://github.com/max-favilli/tagmanager
 * @license      Mozilla Public License, Version 2.0 (http://www.mozilla.org/MPL/2.0/)
 * @version      3.0.2
 * @requires     module:jquery
 */
!function(t){"use strict";var e={prefilled:null,CapitalizeFirstLetter:!1,preventSubmitOnEnter:!0,isClearInputOnEsc:!0,externalTagId:!1,prefillIdFieldName:"Id",prefillValueFieldName:"Value",AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:!0,output:null,deleteTagsOnBackspace:!0,tagsContainer:null,tagCloseIcon:"x",tagClass:"",validator:null,onlyTagList:!1,tagList:null,fillInputOnTagRemove:!1,AjaxPushDataType:"json"},n={pushTag:function(e,n,o,s){var r,a,l,c,u,d,h,f,p,m,g,v,y=t(this),_=y.data("opts"),b=y.data("tlis"),k=y.data("tlid");if(e=i.trimTag(e,_.delimiterChars),e&&!(e.length<=0)){if(_.onlyTagList&&void 0!==_.tagList&&_.tagList){var x=_.tagList;t.each(x,function(t,e){x[t]=e.toLowerCase()});var w=t.inArray(e.toLowerCase(),x);if(-1===w)return}if(_.CapitalizeFirstLetter&&e.length>1&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()),!s&&_.validator&&!_.validator(e))return void y.trigger("tm:invalid",e);if(!(_.maxTags>0&&b.length>=_.maxTags)){if(r=!1,a=jQuery.map(b,function(t){return t.toLowerCase()}),u=t.inArray(e.toLowerCase(),a),-1!==u&&(r=!0),r)if(y.trigger("tm:duplicated",e),_.blinkClass)for(var C=0;6>C;++C)t("#"+y.data("tm_rndid")+"_"+k[u]).queue(function(e){t(this).toggleClass(_.blinkClass),e()}).delay(100);else t("#"+y.data("tm_rndid")+"_"+k[u]).stop().animate({backgroundColor:_.blinkBGColor_1},100).animate({backgroundColor:_.blinkBGColor_2},100).animate({backgroundColor:_.blinkBGColor_1},100).animate({backgroundColor:_.blinkBGColor_2},100).animate({backgroundColor:_.blinkBGColor_1},100).animate({backgroundColor:_.blinkBGColor_2},100);else{_.externalTagId===!0?(void 0===o&&t.error("externalTagId is not passed for tag -"+e),c=o):(l=Math.max.apply(null,k),l=l===-(1/0)?0:l,c=++l),n||y.trigger("tm:pushing",[e,c]),b.push(e),k.push(c),n||null!==_.AjaxPush&&null==_.AjaxPushAllTags&&-1===t.inArray(e,_.prefilled)&&t.post(_.AjaxPush,t.extend({tag:e},_.AjaxPushParameters),null,_.AjaxPushDataType),d=y.data("tm_rndid")+"_"+c,h=y.data("tm_rndid")+"_Remover_"+c,f=t("<span/>").text(e).html(),p='<span class="'+i.tagClasses.call(y)+'" id="'+d+'">',p+="<span>"+f+"</span>",p+='<a href="#" class="tm-tag-remove" id="'+h+'" TagIdToRemove="'+c+'">',p+=_.tagCloseIcon+"</a></span> ",m=t(p);var S=void 0!==y.parents(".twitter-typeahead")[0];if(null!==_.tagsContainer)t(_.tagsContainer).append(m);else if(k.length>1)if(S){var g=y.data("tm_rndid")+"_"+--c;jQuery("#"+g).after(m)}else v=y.siblings("#"+y.data("tm_rndid")+"_"+k[k.length-2]),v.after(m);else S?y.parents(".twitter-typeahead").before(m):y.before(m);m.find("#"+h).on("click",y,function(e){e.preventDefault();var n=parseInt(t(this).attr("TagIdToRemove"));i.spliceTag.call(y,n,e.data)}),i.refreshHiddenTagList.call(y),n||y.trigger("tm:pushed",[e,c]),i.showOrHide.call(y)}y.val("")}}},popTag:function(){var e,n,o=t(this),s=o.data("tlis"),r=o.data("tlid");r.length>0&&(e=r.pop(),n=s[s.length-1],o.trigger("tm:popping",[n,e]),s.pop(),t("#"+o.data("tm_rndid")+"_"+e).remove(),i.refreshHiddenTagList.call(o),o.trigger("tm:popped",[n,e]),i.showOrHide.call(o))},empty:function(){for(var e,n=t(this),o=n.data("tlis"),s=n.data("tlid");s.length>0;)e=s.pop(),o.pop(),t("#"+n.data("tm_rndid")+"_"+e).remove(),i.refreshHiddenTagList.call(n);n.trigger("tm:emptied",null),i.showOrHide.call(n)},tags:function(){var t=this,e=t.data("tlis");return e}},i={showOrHide:function(){var t=this,e=t.data("opts"),n=t.data("tlis");e.maxTags>0&&n.length<e.maxTags&&(t.show(),t.trigger("tm:show")),e.maxTags>0&&n.length>=e.maxTags&&(t.hide(),t.trigger("tm:hide"))},tagClasses:function(){var e,n=t(this),i=n.data("opts"),o=i.tagBaseClass,s=i.inputBaseClass;return e=o,n.attr("class")&&t.each(n.attr("class").split(" "),function(t,n){-1!==n.indexOf(s+"-")&&(e+=" "+o+n.substring(s.length))}),e+=i.tagClass?" "+i.tagClass:""},trimTag:function(e,n){var i;for(e=t.trim(e),i=0;i<e.length&&-1===t.inArray(e.charCodeAt(i),n);i++);return e.substring(0,i)},refreshHiddenTagList:function(){var e=t(this),n=e.data("tlis"),i=e.data("lhiddenTagList");i&&t(i).val(n.join(e.data("opts").baseDelimiter)).change(),e.trigger("tm:refresh",n.join(e.data("opts").baseDelimiter))},killEvent:function(t){t.cancelBubble=!0,t.returnValue=!1,t.stopPropagation(),t.preventDefault()},keyInArray:function(e,n){return-1!==t.inArray(e.which,n)},applyDelimiter:function(e){var i=t(this);n.pushTag.call(i,t(this).val()),e.preventDefault()},prefill:function(e){var i=t(this),o=i.data("opts");t.each(e,function(t,e){o.externalTagId===!0?n.pushTag.call(i,e[o.prefillValueFieldName],!0,e[o.prefillIdFieldName],!0):n.pushTag.call(i,e,!0,!1,!0)})},pushAllTags:function(e,n){var i=t(this),o=i.data("opts"),s=i.data("tlis");o.AjaxPushAllTags&&("tm:pushed"!==e.type||-1===t.inArray(n,o.prefilled))&&t.post(o.AjaxPush,t.extend({tags:s.join(o.baseDelimiter)},o.AjaxPushParameters))},spliceTag:function(e){var n,o=this,s=o.data("tlis"),r=o.data("tlid"),a=t.inArray(e,r);-1!==a&&(n=s[a],o.trigger("tm:splicing",[n,e]),t("#"+o.data("tm_rndid")+"_"+e).remove(),s.splice(a,1),r.splice(a,1),i.refreshHiddenTagList.call(o),o.trigger("tm:spliced",[n,e])),i.showOrHide.call(o)},init:function(o){var s,r,a=t.extend({},e,o);return a.hiddenTagListName=null===a.hiddenTagListName?"hidden-"+this.attr("name"):a.hiddenTagListName,s=a.delimeters||a.delimiters,r=[9,13,17,18,19,37,38,39,40],a.delimiterChars=[],a.delimiterKeys=[],t.each(s,function(e,n){-1!==t.inArray(n,r)?a.delimiterKeys.push(n):a.delimiterChars.push(n)}),a.baseDelimiter=String.fromCharCode(a.delimiterChars[0]||44),a.tagBaseClass="tm-tag",a.inputBaseClass="tm-input",t.isFunction(a.validator)||(a.validator=null),this.each(function(){var e=t(this),o="",s="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";if(e.data("tagManager"))return!1;e.data("tagManager",!0);for(var l=0;5>l;l++)s+=r.charAt(Math.floor(Math.random()*r.length));if(e.data("tm_rndid",s),e.data("opts",a).data("tlis",[]).data("tlid",[]),null===a.output?(o=t("<input/>",{type:"hidden",name:a.hiddenTagListName}),e.after(o),e.data("lhiddenTagList",o)):e.data("lhiddenTagList",t(a.output)),a.AjaxPushAllTags&&(e.on("tm:spliced",i.pushAllTags),e.on("tm:popped",i.pushAllTags),e.on("tm:pushed",i.pushAllTags)),e.on("focus keypress",function(e){t(this).popover&&t(this).popover("hide")}),a.isClearInputOnEsc&&e.on("keyup",function(e){27===e.which&&(t(this).val(""),i.killEvent(e))}),e.on("keypress",function(t){i.keyInArray(t,a.delimiterChars)&&i.applyDelimiter.call(e,t)}),e.on("keydown",function(t){13===t.which&&a.preventSubmitOnEnter&&i.killEvent(t),i.keyInArray(t,a.delimiterKeys)&&i.applyDelimiter.call(e,t)}),a.deleteTagsOnBackspace&&e.on("keydown",function(o){i.keyInArray(o,a.backspace)&&t(this).val().length<=0&&(n.popTag.call(e),i.killEvent(o))}),a.fillInputOnTagRemove&&e.on("tm:popped",function(e,n){t(this).val(n)}),e.change(function(t){/webkit/.test(navigator.userAgent.toLowerCase())||e.focus(),i.killEvent(t)}),null!==a.prefilled)"object"==typeof a.prefilled?i.prefill.call(e,a.prefilled):"string"==typeof a.prefilled?i.prefill.call(e,a.prefilled.split(a.baseDelimiter)):"function"==typeof a.prefilled&&i.prefill.call(e,a.prefilled());else if(null!==a.output){if(t(a.output)&&t(a.output).val()){t(a.output)}i.prefill.call(e,t(a.output).val().split(a.baseDelimiter))}}),this}};t.fn.tagsManager=function(e){var o=t(this);return 0 in this?n[e]?n[e].apply(o,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?(t.error("Method "+e+" does not exist."),!1):i.init.apply(this,arguments):this}}(jQuery);
